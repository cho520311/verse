<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古韻詩詞標註工具 - 瀛社三七同系統</title>
    <style>
        :root {
            --paper-bg: #fdf5e6; 
            --ink-black: #2c3e50;
            --classic-red: #a93226; 
            --classic-blue: #2e59a7; 
            --soft-gold: #d4af37;
        }
        body {
            background-color: var(--paper-bg);
            background-image: linear-gradient(rgba(253, 245, 230, 0.7), rgba(253, 245, 230, 0.7)), 
                              url('https://images.unsplash.com/photo-1571168128527-36e655610ec1?q=80&w=2000&auto=format&fit=crop'); 
            background-size: cover; background-attachment: fixed;
            font-family: "Kaiti TC", "KaiTi", "標楷體", serif;
            margin: 0; display: flex; justify-content: center; padding: 10px;
        }
        .container {
            max-width: 850px; width: 100%; background: rgba(255, 255, 255, 0.95); 
            padding: 20px; border: 2px solid #ddd; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header-area { text-align: center; margin-bottom: 20px; }
        h1 { color: var(--classic-red); font-size: 32px; margin: 0; letter-spacing: 6px; font-weight: bold; }
        .instructor { color: var(--ink-black); font-size: 22px; font-weight: bold; margin: 15px 0 5px 0; }
        .subtitle { color: #444; font-size: 18px; margin: 5px 0; font-weight: bold; display: block; }
        
        .status-info { color: #666; font-size: 14px; margin-bottom: 10px; }
        
        textarea { 
            width: 100%; height: 120px; padding: 15px; font-size: 20px; 
            border-radius: 4px; box-sizing: border-box; 
            font-family: "Kaiti TC", "KaiTi", "標楷體", serif; 
            border: 1px solid #ccc; background: white; 
        }
        
        .btn-group { display: flex; gap: 10px; justify-content: center; margin: 25px 0; flex-wrap: wrap; }
        button, .btn-link { 
            font-family: "Kaiti TC", "KaiTi", "標楷體", serif;
            font-weight: bold; font-size: 20px; padding: 12px 24px; 
            border: 2px solid var(--classic-red); background: white; color: var(--classic-red); 
            cursor: pointer; border-radius: 8px; text-decoration: none; display: inline-block; 
            transition: 0.2s;
        }
        button:hover, .btn-link:hover { background: var(--classic-red); color: white; }
        button:disabled { border-color: #ccc; color: #ccc; cursor: not-allowed; }

        #output { 
            line-height: 3.5; font-size: 32px; color: var(--ink-black); 
            min-height: 150px; padding: 30px 10px; 
            border-top: 2px double var(--soft-gold); text-align: center; 
        }

        ruby { display: inline-flex; flex-direction: column-reverse; vertical-align: bottom; align-items: center; margin: 0 0.15em; }
        rt { font-size: 16px; line-height: 1.2; font-family: Arial, sans-serif; font-weight: bold; margin-bottom: 2px; }
        rt.ping { color: var(--classic-blue); } 
        rt.ze { color: var(--classic-red); }

        @media print {
            .input-wrapper, .btn-group, .status-info { display: none; }
            body { background: white; padding: 0; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header-area">
        <h1>古韻詩詞標註</h1>
        <div class="instructor">瀛社 林正三老師 吳秀真老師 指導</div>
        <div class="subtitle">依《音韻闡微》三七同方式拼音</div>
        <div id="loadStatus" class="status-info">正在連線至雲端字典...</div>
    </div>

    <div class="input-wrapper">
        <textarea id="poemInput" placeholder="請在此輸入詩句..."></textarea>
    </div>

    <div class="btn-group">
        <button id="convertBtn" onclick="process()" disabled>同步資料中...</button>
        <button onclick="window.print()">列印/PDF</button>
        <button onclick="location.reload()">重新讀取字典</button>
    </div>

    <div id="output"></div>

    <div style="text-align: center; margin-top: 30px; font-style: italic; color: #a93226; font-size: 18px; font-weight: bold;">
        「上取聲母定清濁，下取韻母定四聲。」
    </div>
</div>

<script>
    // 您的試算表 ID
    const sheetId = '1A260Bg4rABNI7x26MPjFyThIoh4RkMF4E8CRZeUKd68';
    // 讀取 CSV 格式的網址
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

    let cloudDict = {};

    // 頁面加載後自動去撈資料
    async function fetchCloudData() {
        try {
            const response = await fetch(sheetUrl);
            const data = await response.text();
            
            // 解析 CSV 格式 (處理簡單引號與逗號)
            const rows = data.split('\n');
            rows.forEach(row => {
                // 去掉 CSV 的雙引號並分割
                const columns = row.split(',').map(col => col.replace(/^"(.*)"$/, '$1'));
                if (columns.length >= 2) {
                    const char = columns[0].trim();
                    const pinyin = columns[1].trim();
                    cloudDict[char] = pinyin;
                }
            });

            document.getElementById('loadStatus').innerText = `雲端字典同步成功！已讀取 ${Object.keys(cloudDict).length} 個漢字。`;
            document.getElementById('convertBtn').innerText = "開始轉換";
            document.getElementById('convertBtn').disabled = false;
        } catch (error) {
            console.error(error);
            document.getElementById('loadStatus').innerText = "連線失敗，請確認試算表已開啟共用。";
        }
    }

    function process() {
        const input = document.getElementById('poemInput').value;
        const outputDiv = document.getElementById('output');
        outputDiv.innerHTML = '';

        let resultHTML = "";
        for (let char of input) {
            if (cloudDict[char]) {
                const pinyin = cloudDict[char];
                // 抓取拼音結尾的數字決定平仄 (1,2,5,6 平; 3,4,7,8 仄)
                const toneMatch = pinyin.match(/\d$/);
                const tone = toneMatch ? toneMatch[0] : "1";
                
                let toneClass = "ze";
                if (["1", "2", "5", "6"].includes(tone)) {
                    toneClass = "ping";
                }

                resultHTML += `<ruby>${char}<rt class="${toneClass}">${pinyin}</rt></ruby>`;
            } else if (char === "\n") {
                resultHTML += "<br>";
            } else {
                resultHTML += `<span>${char}</span>`;
            }
        }
        outputDiv.innerHTML = resultHTML;
    }

    // 初始化讀取
    fetchCloudData();
</script>
</body>
</html>
